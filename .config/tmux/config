set -gF @nested "#{||:#{==:#{host},sheep},#{!=:#{SSH_CONNECTION},}}"

%if #{==:#{TERM},linux}
set -g status-fg color7
set -g status-bg color0

set -g window-status-format "#I:#W#F"
set -g window-status-current-style fg=color15,bold
set -g window-status-activity fg=color1
set -g window-status-separator ' '

set -g message-command-style bg=color0,fg=color15
set -g message-style bg=color0,fg=color15
set -g mode-style bg=color15,fg=color0

set -g pane-border-style bg=color0,fg=color7
set -g pane-active-border-style bg=color0,fg=color15

set -g display-panes-colour color7
set -g display-panes-active-colour color15
%else
source-file ~/.config/tmux/theme.conf

set -g status-left "[#S]"
set -g status-right "%a, %b %d %R"

# Really... making this fucking colon fucking optional is FUCKING IMPOSSIBLE.
# WHY? THE FUCK? LITTLE SHITS. Why the fuck string interpolation is so fucking hard.
set -g @window-status-format " #[fg=color245]#[default]#I#[fg=color245]:#[fg=default]#W#[fg=color245]:#[fg=default]#{?synchronize-panes,~,}#{window_flags}#{?monitor-activity,A,} "
set -g window-status-format "#{E:@window-status-format}"
set -g window-status-current-format "#{E:@window-status-format}"

set -g window-status-activity-style bold,bg=color191,fg=color0
set -g window-status-bell-style bold,fg=color196,bg=color221
set -g window-status-separator ''

set -g pane-border-indicators arrows
set -g pane-border-lines single
set -g pane-border-format "#{pane_index} #W:#T @ #{pane_tty}"

set -g message-command-style bg=color254,fg=color250
set -g message-style bg=color220,fg=color236
set -g mode-style bg=color220,fg=color236

set -g copy-mode-match-style bg=#fdef39
set -g copy-mode-current-match-style bg=#fdef39
%endif

set -g aggressive-resize on
set -g bell-action server-other
set -g clock-mode-style 24
set -g default-command "$SHELL" # Disable login shells.
set -g default-terminal "$TERM"
set -g display-time 0
set -g escape-time 0
set -g focus-events on
set -g history-limit 20000
set -gF prefix "#{?@nested,C-b,C-t}"
set -g renumber-windows on
set -g repeat-time 418
set -g set-titles on
set -g set-titles-string '[#S]:#W #T'
set -g status-interval 20
set -g status-keys emacs
set -g visual-bell on
set -ga terminal-overrides ",*:Tc" # True color.
set -ga terminal-overrides ',*:Ss=\E[%p1%d q:Se=\E[2 q' # Cursor shape.
# SSH_AUTH_SOCK is in the global environment.
set -g update-environment 'DISPLAY'

set-hook -g after-split-window[1] { select-layout tiled }
set-hook -g window-layout-changed[2] { set -wF pane-border-status '#{?#{==:#{window_panes},1},off,bottom}' }

unbind -a

set -g mode-keys vi

bind : command-prompt
bind d detach-client

bind c new-window -a -t : -c "#{pane_current_path}"
bind s split-window -c "#{pane_current_path}"
bind C command-prompt -p '(new-session)' { new-session -s '%%' }

bind C-p display-popup -E progress -M
bind C-s display-popup -E ~/.config/heawm/quickstart

bind $ command-prompt -I '#S' -p '(rename-session)' { rename-session -- '%%' }
bind , command-prompt -I '#W' -p '(rename-window)' { rename-window -- '%%' }

bind C-c display-menu -T 'Kill' \
	'INT'  i { run-shell "~/.config/tmux/scripts/kill '#{pane_tty}' INT " } \
	'STOP' s { run-shell "~/.config/tmux/scripts/kill '#{pane_tty}' TSTP" } \
	'TERM' t { run-shell "~/.config/tmux/scripts/kill '#{pane_tty}' TERM" } \
	'CONT' c { run-shell "~/.config/tmux/scripts/kill '#{pane_tty}' CONT" } \
	'KILL' K { run-shell "~/.config/tmux/scripts/kill '#{pane_tty}' KILL" } \

bind t last-pane
bind C-t last-window
bind T switch-client -l

bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

bind 0 select-window -t:=0
bind 1 select-window -t:=1
bind 2 select-window -t:=2
bind 3 select-window -t:=3
bind 4 select-window -t:=4
bind 5 select-window -t:=5
bind 6 select-window -t:=6
bind 7 select-window -t:=7
bind 8 select-window -t:=8
bind 9 select-window -t:=9

bind n next-window
bind p previous-window
bind '!' next-window -a

bind H swap-pane -dt '{left-of}'
bind J swap-pane -dt '{down-of}'
bind K swap-pane -dt '{up-of}'
bind L swap-pane -dt '{right-of}'

bind N swap-window -dt :+1
bind P swap-window -dt :-1

bind ) switch-client -n
bind ( switch-client -p

bind f display-popup -E ~/.config/tmux/scripts/find
bind F choose-tree -Z

bind "'" select-pane -m
bind z resize-pane -Z

bind ' ' display-menu -T 'Layout' \
	'k-master' k { select-layout main-horizontal } \
	'h-master' h { select-layout main-vertical } \
	'grid' g { select-layout tiled } \
	'row' r { select-layout even-horizontal } \
	'column' c { select-layout even-vertical } \

bind W if -F '#{@title}' \
	{ set -wu @title   ; set -w window-status-format "#{E:@window-status-format}" } \
	{ set -w  @title 1 ; set -w window-status-format "#{E:@window-status-format}#T" } \;\
	set -w window-status-current-format "#{E:window-status-format}"

bind > send-keys -t :muck C-m
bind . send-keys -t :muck c

bind M if -F '#{!=:#{window_name},muck}' {
	set -F @last_session "#{session_name}" ;
	select-pane -m ;
	attach-session -t home ;
	select-window -t muck
} {
	run-shell "tmux switch-client -t #{@last_session}"
}

bind r source-file ~/.tmux.conf

bind y copy-mode
# bind Y choose-buffer { run-shell -b "tmux show-buffer -b '%%' | xclip -i" }
bind / copy-mode \; send-keys ?
bind C-u copy-mode \; send-keys -X halfpage-up
bind v copy-mode \; send-keys -X begin-selection
bind V copy-mode \; send-keys -X select-line
bind e split-window -vZ "tmux capture-pane -p -t- -S- | sed 's/\\s*$//' | nvim +normal!G{}k"
bind E split-window -vZ "tmux capture-pane -p -t- -S0 | sed 's/\\s*$//' | nvim +normal!G{}k"

bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi + \
	send-keys -X copy-selection-and-cancel \;\
	delete-buffer -b xclip_paste \;\
	set-buffer -n xclip_paste \;\
	run-shell -b "tmux show-buffer -b xclip_paste | xclip -silent -i -selection clipboard"

bind a paste-buffer
bind b choose-buffer
bind C-l clear-history \; display-message "History cleared."
bind C-m show-messages

bind * set -s @xclip_selection primary   \; source ~/.config/tmux/functions/xclip
bind + set -s @xclip_selection clipboard \; source ~/.config/tmux/functions/xclip

bind '~' set -w synchronize-panes
bind m set -w monitor-activity \; if -F '#{monitor-activity}' 'last-window'

# vim: ft=tmux fdm=marker
