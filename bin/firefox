#!/bin/dash
NEW_USER=nobody
NEW_HOME=/home/$NEW_USER
tmp=$(mktemp)
grep audio /etc/group >$tmp
exec 7<$tmp
unlink "$tmp"

echo >$tmp "$NEW_USER:x:$(id -u):$(id -g)::$NEW_HOME:$SHELL"
exec 8<$tmp
unlink "$tmp"

# /proc/self/exe needed.
# IPC and matching $(id -u) required for ALSA.

ulimit -u 1000
exec env -i "TERMINAL=$TERMINAL" MOZ_FORCE_DISABLE_E10S=1 MOZ_USE_XINPUT2=1 bwrap \
	--as-pid-1 \
	--unshare-pid \
	--unshare-cgroup \
	--unshare-uts \
	--unshare-user \
	--ro-bind /usr/bin/python3 /usr/bin/python3 \
	--ro-bind /usr/bin/env /usr/bin/env \
	--ro-bind /usr/bin/sh /usr/bin/sh \
	--ro-bind /usr/bin/ps /usr/bin/ps \
	--ro-bind /usr/bin/find /usr/bin/find \
	--ro-bind /usr/bin/nvim /usr/bin/nvim \
	--ro-bind /usr/local/bin/alacritty /usr/local/bin/alacritty \
	--ro-bind /usr/bin/firefox /usr/bin/firefox \
	--ro-bind /usr/lib /usr/lib \
	--ro-bind /usr/share /usr/share \
	--ro-bind /sys/devices /sys/devices \
	--ro-bind /sys/dev /sys/dev \
	--symlink usr/bin /sbin \
	--symlink usr/bin /bin \
	--symlink usr/lib /lib64 \
	--symlink usr/lib /lib \
	--ro-bind-try /etc/drirc /etc/drirc \
	--ro-bind /etc/resolv.conf /etc/resolv.conf \
	--ro-bind /etc/fonts /etc/fonts \
	--ro-bind-try /etc/alsa /etc/alsa \
	--ro-bind-try /etc/asound.conf /etc/asound.conf \
	--file 7 /etc/group \
	--file 8 /etc/passwd \
	--proc /proc \
	--ro-bind /etc/ld.so.cache /etc/ld.so.cache \
	--ro-bind /etc/ld.so.preload /etc/ld.so.preload \
	--ro-bind /etc/hosts /etc/hosts \
	--ro-bind /etc/ca-certificates /etc/ca-certificates \
	--ro-bind /etc/gai.conf /etc/gai.conf \
	--ro-bind /etc/mime.types /etc/mime.types \
	--ro-bind /etc/gtk-3.0 /etc/gtk-3.0 \
	--ro-bind /var/cache/fontconfig /var/cache/fontconfig \
	--dev-bind /dev/snd /dev/snd \
	--dev-bind /dev/dri /dev/dri \
	--hostname "$HOST" \
	--dir "$NEW_HOME" \
	--bind "$HOME/mem" "$NEW_HOME/Downloads" \
	--ro-bind-try "$HOME/.XCompose" "$NEW_HOME/.XCompose" \
	--ro-bind-try "$HOME/.drirc" "$NEW_HOME/.drirc" \
	--setenv HOME "$NEW_HOME" \
	--ro-bind-try /tmp/.X11-unix /tmp/.X11-unix \
	--ro-bind-try "$XAUTHORITY" "$NEW_HOME/.Xauthority" \
	--setenv "${WAYLAND_DISPLAY:-unset_}WAYLAND_DISPLAY" "$WAYLAND_DISPLAY" \
	--setenv DISPLAY "$DISPLAY" \
	--setenv XDG_RUNTIME_DIR $XDG_RUNTIME_DIR \
	--ro-bind "$HOME/.local/share/nvim/site" "$NEW_HOME/.local/share/nvim/site" \
	--ro-bind "$HOME/.local/share/tridactyl" "$NEW_HOME/.local/share/tridactyl" \
	--ro-bind "$HOME/.config/nvim" "$NEW_HOME/.config/nvim" \
	--ro-bind "$HOME/.config/fontconfig" "$NEW_HOME/.config/fontconfig" \
	--ro-bind "$HOME/.config/firefox" "$NEW_HOME/.config/firefox" \
	--ro-bind "$HOME/.config/tridactyl" "$NEW_HOME/.config/tridactyl" \
	--ro-bind "$HOME/.config/alacritty" "$NEW_HOME/.config/alacritty" \
	--ro-bind "$HOME/.config/alsa" "$NEW_HOME/.config/alsa" \
	--bind "$XDG_RUNTIME_DIR/firefox" "$XDG_RUNTIME_DIR/firefox" \
	--bind-try "$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY" "$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY" \
	--ro-bind-try "$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY.lock" "$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY.lock" \
	--bind "$HOME/.mozilla" "$NEW_HOME/.mozilla" \
	--setenv LANG "$LANG" \
	--setenv ALSA "$ALSA" \
	--setenv TZ "$TZ" \
	--chdir "$NEW_HOME" \
	--new-session \
	/bin/firefox "$@"
